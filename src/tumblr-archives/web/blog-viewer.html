<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Blog Viewer - Tumblr Archives</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous" />
  <style>
    ul {
      list-style-type: none;
    }

    li {
      height: 40vh;
      flex-grow: 1;
      border: 1px black solid;
    }

    img {
      max-height: 100%;
      min-width: 100%;
      object-fit: cover;
      vertical-align: bottom;
    }

    li:last-child {
      flex-grow: 10;
    }
  </style>
</head>

<body>
  <div class="container-fluid">
    <div class="row p-3 justify-content-center">
      <div class="col col-3">
        <input class="form-control" type="text" name="blog" id="blog" />
      </div>
    </div>
    <div class="row">
      <div class="col">
        <ul class="d-flex flex-wrap m-0 p-0"></ul>
      </div>
    </div>
  </div>
  <script defer>
    const blogInput = document.querySelector("#blog");
    let lastBlogInputValue;

    blogInput.addEventListener("focusout", async () => {
      if (!blogInput.value || lastBlogInputValue === blogInput.value) {
        return;
      }

      lastBlogInputValue = blogInput.value;

      const ul = document.querySelector("ul");

      ul.replaceChildren();

      let offset = 0;

      while (true) {
        const images = await fetch(
          `/blog-images?blog=${blogInput.value}&offset=${offset}`,
        ).then((response) => response.json());

        if (!images.length) {
          break;
        }

        const { images: booruImages } = await fetch(
          `https://derpibooru.org/api/v1/json/search/images?q=${images.map((i) => `source_url:*${i.postId}*`).join(" || ")}&filter_id=56027&per_page=50`,
        ).then((response) => response.json());

        for (const image of images) {
          const li = document.createElement("li");
          const a = document.createElement("a");
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.href = image.href;
          const img = document.createElement("img");
          img.src = image.src;
          li.appendChild(a);
          a.appendChild(img);
          ul.appendChild(li);

          const booruImage = booruImages.find((i) =>
            i.source_urls.some(su => su.includes(image.postId)),
          );

          if (booruImage) {
            const div = document.createElement("div");

            div.style.position = "absolute";
            div.style.color = "white";
            div.style.fontSize = "1.8rem";
            div.style.marginLeft = "10px";
            div.style.textShadow =
              "0.07em 0 black, 0 0.07em black, -0.07em 0 black, 0 -0.07em black";

            div.innerText = `Derpibooru: #${booruImage.id}`

            li.insertAdjacentElement("afterbegin", div);
          }
        }

        offset += 10;
      }

      ul.appendChild(document.createElement("li"));
    });
  </script>
</body>

</html>